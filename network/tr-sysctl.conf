############################################################
# Optimized sysctl.conf for 10G Network, 128-Core, 258GB RAM
############################################################

##############################
# Kernel Parameters
##############################
# --- Core dump & Dmesg 保護 ---
kernel.core_pattern           = |/usr/lib/systemd/systemd-coredump %P %u %g %s %t %c %h
kernel.core_pipe_limit        = 16
kernel.core_uses_pid          = 1
kernel.dmesg_restrict         = 1
kernel.randomize_va_space     = 2
kernel.pid_max                = 4194304

# --- NUMA と共有メモリ ---
# NUMA バランシング：手動調整する場合は無効にしておく（必要に応じて有効化）
kernel.numa_balancing         = 0
# 共有メモリ上限（用途に合わせて調整する例：現在 16GB → 必要ならコメントアウト解除して値を変更）
# kernel.shmmax               = 137438953472

##############################
# Scheduler & CFS Tuning
##############################
kernel.sched_latency_ns             = 10000000
kernel.sched_migration_cost_ns        = 5000000
kernel.sched_min_granularity_ns       = 1000000
kernel.sched_wakeup_granularity_ns    = 1500000

##############################
# IPC and File Limits
##############################
fs.file-max                   = 19349474
fs.nr_open                    = 1073741816
kernel.threads-max            = 4000000

##############################
# Networking Parameters
##############################
net.core.default_qdisc        = fq
net.core.netdev_max_backlog   = 16384
net.core.rmem_max             = 33554432
net.core.wmem_max             = 33554432

net.ipv4.tcp_congestion_control = bbr
net.ipv4.tcp_fastopen         = 3
net.ipv4.tcp_syncookies       = 1
net.ipv4.tcp_max_syn_backlog   = 65535
net.ipv4.ip_local_port_range   = 1024 65535
net.ipv4.tcp_rmem             = 4096 87380 16777216
net.ipv4.tcp_wmem             = 4096 87380 16777216
net.ipv4.forwarding           = 1

# --- Additional TCP Tuning ---
net.ipv4.tcp_fin_timeout     = 30
net.ipv4.tcp_tw_reuse        = 1
net.ipv4.tcp_keepalive_time  = 600
net.ipv4.tcp_keepalive_intvl = 60
net.ipv4.tcp_keepalive_probes= 5
net.ipv4.tcp_window_scaling  = 1
net.ipv4.tcp_timestamps      = 1
net.ipv4.tcp_sack            = 1

# --- IP Fragmentation Control (Optional) ---
net.ipv4.ipfrag_high_thresh  = 4194304
net.ipv4.ipfrag_low_thresh   = 3145728

# --- Optional Busy Polling (if low latency is required) ---
net.core.busy_poll           = 50
net.core.busy_read           = 50

# --- IPv6 Forwarding ---
net.ipv6.conf.all.forwarding     = 1
net.ipv6.conf.default.forwarding = 1

##############################
# Virtual Memory Parameters
##############################
vm.swappiness                 = 10
vm.overcommit_memory          = 2
vm.overcommit_ratio           = 99
vm.dirty_ratio                = 15
vm.dirty_background_ratio     = 5
# ファイルシステムキャッシュを長期間保持（デフォルトの 10000 は過剰な場合が多いため調整）
vm.vfs_cache_pressure         = 50
vm.min_free_kbytes            = 67584   # 必要に応じて調整
vm.max_map_count              = 262144
vm.nr_hugepages               = 4096    # hugepages 使用時は workload に合わせて調整

##############################
# Inotify & Watch Limits
##############################
fs.inotify.max_user_watches   = 524288
fs.inotify.max_queued_events  = 16384
fs.inotify.max_user_instances = 1024

##############################
# Additional Networking (Optional)
##############################
# Netfilter connection tracking（ファイアウォールやコンテナ利用時）
net.netfilter.nf_conntrack_max = 1048560

############################################################
# End of optimized sysctl.conf
############################################################
